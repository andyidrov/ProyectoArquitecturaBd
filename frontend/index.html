<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Banco Online</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f7fa;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    main {
      width: 100%;
      max-width: 450px;
      background: white;
      padding: 30px 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #1d3557;
    }
    .form-section {
      display: none;
      margin-bottom: 20px;
      transition: opacity 0.3s ease;
    }
    .visible {
      display: block !important;
      opacity: 1;
    }
    input, select, button {
      display: block;
      margin: 10px 0 20px 0;
      padding: 12px 15px;
      width: 100%;
      border: 1.8px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      border-color: #457b9d;
      outline: none;
      box-shadow: 0 0 6px #a8dadc;
    }
    button {
      background-color: #1d3557;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #457b9d;
    }
    a {
      color: #1d3557;
      cursor: pointer;
      text-decoration: underline;
    }
    a:hover {
      color: #457b9d;
    }
    p.message {
      margin-top: -15px;
      margin-bottom: 15px;
      color: #e63946; /* rojo error */
      font-weight: 600;
      min-height: 20px;
      transition: opacity 0.3s ease;
    }
    p.message.success {
      color: #2a9d8f; /* verde */
    }
    p.message.hide {
      opacity: 0;
      height: 0;
      margin: 0;
      overflow: hidden;
    }
    /* Mejor separacion de botones en transacciones */
    #transaccionSection button, #transferenciaSection button {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <main>
    <h1>üí≥ Banco Online</h1>

    <!-- üîê LOGIN -->
    <div id="loginSection" class="form-section visible">
      <h2>Iniciar Sesi√≥n</h2>
      <input type="text" id="loginUsuario" placeholder="Usuario" />
      <input type="password" id="loginPassword" placeholder="Contrase√±a" />
      <button onclick="login()">Entrar</button>
      <p>¬øNo tienes cuenta? <a onclick="mostrarRegistro()">Crear cuenta</a></p>
      <p id="loginMsg" class="message hide"></p>
    </div>

    <!-- üìù REGISTRO -->
    <div id="registroSection" class="form-section">
      <h2>Crear Cuenta</h2>
      <input type="text" id="nombre" placeholder="Nombre" oninput="soloLetrasInput(this)" />
      <input type="text" id="apellido" placeholder="Apellido" oninput="soloLetrasInput(this)" />
      <input type="date" id="fechaNacimiento" />
      <select id="estadoCivil">
        <option value="">Estado civil</option>
        <option value="soltero">Soltero</option>
        <option value="casado">Casado</option>
      </select>
      <select id="tipoCuenta">
        <option value="">Tipo de cuenta</option>
        <option value="corriente">Corriente</option>
        <option value="ahorro">Ahorro</option>
      </select>
      <input type="text" id="cedula" maxlength="10" placeholder="C√©dula (10 d√≠gitos)" pattern="\d{10}" />
      <input type="text" id="usuario" placeholder="Usuario (m√°x 20 caracteres)" maxlength="20" />
      <input type="email" id="correo" placeholder="Correo electr√≥nico" />
      <input type="password" id="password" placeholder="Contrase√±a" />
      <button onclick="registrar()">Registrar</button>
      <p id="registroMsg" class="message hide"></p>
    </div>

    <!-- üí∞ TRANSACCIONES -->
    <div id="transaccionSection" class="form-section">
      <h2>Transacciones</h2>
      <p>Bienvenido, <strong id="usuarioActivo"></strong></p>
      <p id="saldoMsg" class="message hide"></p>
      <select id="tipoTransaccion">
        <option value="deposito">Dep√≥sito</option>
        <option value="retiro">Retiro</option>
      </select>
      <input type="number" id="monto" placeholder="Monto" />
      <button onclick="transaccion()">Realizar Transacci√≥n</button>
      <p id="transaccionMsg" class="message hide"></p>

      <button onclick="mostrarTransferencia()">Hacer Transferencia ‚û°</button>
    </div>

    <!-- üîÑ TRANSFERENCIA -->
    <div id="transferenciaSection" class="form-section">
      <h2>Transferencia</h2>
      <p>Origen: <strong id="usuarioOrigen"></strong></p>
      <input type="text" id="usuarioDestino" placeholder="Usuario destino" />
      <input type="number" id="montoTransferencia" placeholder="Monto a transferir" />
      <button onclick="transferir()">Transferir</button>
      <p id="transferenciaMsg" class="message hide"></p>
      <button onclick="volverTransacciones()">‚¨Ö Volver</button>
    </div>
  </main>

  <script>
    let usuarioLogueado = null;
    const API_URL = window.location.origin + '/api';  // URL adaptable

    // Bloquea la entrada a solo letras, acentos y espacios
    function soloLetrasInput(input) {
      input.value = input.value.replace(/[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]/g, '');
    }

    function mostrarRegistro() {
      setVisibleSection('registroSection');
      limpiarRegistro();
      mostrarMensaje('registroMsg', '', false);
      mostrarMensaje('loginMsg', '', false);
    }

    function mostrarTransferencia() {
      setVisibleSection('transferenciaSection');
      document.getElementById('usuarioOrigen').textContent = usuarioLogueado;
      limpiarTransferencia();
      mostrarMensaje('transferenciaMsg', '', false);
    }

    function volverTransacciones() {
      setVisibleSection('transaccionSection');
      mostrarMensaje('transaccionMsg', '', false);
    }

    function setVisibleSection(idVisible) {
      ['loginSection', 'registroSection', 'transaccionSection', 'transferenciaSection'].forEach(id => {
        const elem = document.getElementById(id);
        if (id === idVisible) {
          elem.classList.add('visible');
          elem.style.opacity = '1';
        } else {
          elem.classList.remove('visible');
          elem.style.opacity = '0';
        }
      });
    }

    function camposVacios(obj) {
      return Object.values(obj).some(val => val.trim() === "");
    }

    function validarCedula(cedula) {
      return /^\d{10}$/.test(cedula);
    }

    function validarCorreo(correo) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(correo);
    }

    function mostrarMensaje(id, msg, isError = true) {
      const p = document.getElementById(id);
      p.textContent = msg;
      if (!msg) {
        p.classList.add('hide');
      } else {
        p.classList.remove('hide');
        p.classList.toggle('success', !isError);
      }
    }

    function limpiarRegistro() {
      ['nombre', 'apellido', 'fechaNacimiento', 'estadoCivil', 'tipoCuenta', 'cedula', 'usuario', 'correo', 'password']
        .forEach(id => document.getElementById(id).value = '');
    }

    function limpiarTransferencia() {
      ['usuarioDestino', 'montoTransferencia'].forEach(id => document.getElementById(id).value = '');
    }

    async function registrar() {
      const data = {
        nombre: document.getElementById('nombre').value.trim(),
        apellido: document.getElementById('apellido').value.trim(),
        fechaNacimiento: document.getElementById('fechaNacimiento').value,
        estadoCivil: document.getElementById('estadoCivil').value,
        tipoCuenta: document.getElementById('tipoCuenta').value,
        cedula: document.getElementById('cedula').value,
        usuario: document.getElementById('usuario').value.trim(),
        correo: document.getElementById('correo').value.trim(),
        password: document.getElementById('password').value.trim(),
      };

      if (camposVacios(data)) {
        mostrarMensaje('registroMsg', 'Todos los campos son obligatorios', true);
        return;
      }

      if (!validarCedula(data.cedula)) {
        mostrarMensaje('registroMsg', 'La c√©dula debe tener 10 d√≠gitos', true);
        return;
      }

      if (!validarCorreo(data.correo)) {
        mostrarMensaje('registroMsg', 'El correo electr√≥nico no es v√°lido', true);
        return;
      }

      try {
        const response = await fetch(`${API_URL}/registro`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        const result = await response.json();

        if (response.ok) {
          mostrarMensaje('registroMsg', 'Cuenta creada exitosamente. Puedes iniciar sesi√≥n ahora.', false);
          setVisibleSection('loginSection');
        } else {
          mostrarMensaje('registroMsg', result.message, true);
        }
      } catch (error) {
        mostrarMensaje('registroMsg', 'Error al registrar. Intenta de nuevo.', true);
      }
    }

    async function login() {
      const usuario = document.getElementById('loginUsuario').value.trim();
      const password = document.getElementById('loginPassword').value.trim();

      if (!usuario || !password) {
        mostrarMensaje('loginMsg', 'Usuario y contrase√±a son requeridos.', true);
        return;
      }

      try {
        const response = await fetch(`${API_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario, password }),
        });
        const result = await response.json();

        if (response.ok) {
          usuarioLogueado = result.usuario;
          mostrarMensaje('loginMsg', 'Inicio de sesi√≥n exitoso', false);
          setVisibleSection('transaccionSection');
          document.getElementById('usuarioActivo').textContent = usuarioLogueado;
        } else {
          mostrarMensaje('loginMsg', result.message, true);
        }
      } catch (error) {
        mostrarMensaje('loginMsg', 'Error al iniciar sesi√≥n. Intenta de nuevo.', true);
      }
    }

    async function transaccion() {
      const tipo = document.getElementById('tipoTransaccion').value;
      const monto = parseFloat(document.getElementById('monto').value);

      if (isNaN(monto) || monto <= 0) {
        mostrarMensaje('transaccionMsg', 'El monto debe ser mayor a cero', true);
        return;
      }

      try {
        const response = await fetch(`${API_URL}/transacciones`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tipo, monto, usuario: usuarioLogueado }),
        });
        const result = await response.json();

        if (response.ok) {
          mostrarMensaje('transaccionMsg', `Transacci√≥n de ${tipo} realizada con √©xito`, false);
        } else {
          mostrarMensaje('transaccionMsg', result.message, true);
        }
      } catch (error) {
        mostrarMensaje('transaccionMsg', 'Error en la transacci√≥n. Intenta de nuevo.', true);
      }
    }

    async function transferir() {
      const usuarioDestino = document.getElementById('usuarioDestino').value.trim();
      const monto = parseFloat(document.getElementById('montoTransferencia').value);

      if (!usuarioDestino || isNaN(monto) || monto <= 0) {
        mostrarMensaje('transferenciaMsg', 'Completa todos los campos correctamente', true);
        return;
      }

      try {
        const response = await fetch(`${API_URL}/transferencias`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuarioOrigen: usuarioLogueado, usuarioDestino, monto }),
        });
        const result = await response.json();

        if (response.ok) {
          mostrarMensaje('transferenciaMsg', 'Transferencia realizada con √©xito', false);
          setVisibleSection('transaccionSection');
        } else {
          mostrarMensaje('transferenciaMsg', result.message, true);
        }
      } catch (error) {
        mostrarMensaje('transferenciaMsg', 'Error en la transferencia. Intenta de nuevo.', true);
      }
    }
  </script>
</body>
</html>
